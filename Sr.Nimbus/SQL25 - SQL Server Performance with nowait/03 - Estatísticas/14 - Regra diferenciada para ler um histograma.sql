/*
  SQL25 - SQL Server Performance with nowait
  http://www.srnimbus.com.br
*/

-----------------------------------------------
-- Regra diferenciada para ler um histograma --
-----------------------------------------------

USE tempdb
GO
IF OBJECT_ID('Order_DetailsBig') IS NOT NULL
  DROP TABLE Order_DetailsBig
GO
CREATE TABLE [dbo].[Order_DetailsBig](
	[OrderID] [int] NOT NULL,
	[ProductID] [int] NOT NULL,
	[Data_Entrega] [datetime] NOT NULL,
	[Quantity] [int] NULL,
 CONSTRAINT [xpk_Order_DetailsBig] PRIMARY KEY CLUSTERED 
(
	[OrderID] ASC,
	[ProductID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
CREATE STATISTICS Stats_Quantity ON Order_DetailsBig(Quantity) WITH FULLSCAN
GO

UPDATE STATISTICS Order_DetailsBig WITH ROWCOUNT = 50000, PAGECOUNT = 180
GO
UPDATE STATISTICS Order_DetailsBig Stats_Quantity WITH STATS_STREAM = 0x01000000010000000000000000000000FC41AE1F00000000C5190000000000008519000000000000380200003800000004000A000000000000000000000000000700000059A0E700859E000050C300000000000050C300000000000016EE943C5379913A0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C7000000C70000000100000014000000000080400050434700000000000080400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110000000000000000000000000000001918000000000000211800000000000038060000000000004F0600000000000066060000000000007D060000000000009406000000000000AB06000000000000C206000000000000D906000000000000F00600000000000007070000000000001E0700000000000035070000000000004C0700000000000063070000000000007A070000000000009107000000000000A807000000000000BF07000000000000D607000000000000ED0700000000000004080000000000001B0800000000000032080000000000004908000000000000600800000000000077080000000000008E08000000000000A508000000000000BC08000000000000D308000000000000EA08000000000000010900000000000018090000000000002F0900000000000046090000000000005D0900000000000074090000000000008B09000000000000A209000000000000B909000000000000D009000000000000E709000000000000FE09000000000000150A0000000000002C0A000000000000430A0000000000005A0A000000000000710A000000000000880A0000000000009F0A000000000000B60A000000000000CD0A000000000000E40A000000000000FB0A000000000000120B000000000000290B000000000000400B000000000000570B0000000000006E0B000000000000850B0000000000009C0B000000000000B30B000000000000CA0B000000000000E10B000000000000F80B0000000000000F0C000000000000260C0000000000003D0C000000000000540C0000000000006B0C000000000000820C000000000000990C000000000000B00C000000000000C70C000000000000DE0C000000000000F50C0000000000000C0D000000000000230D0000000000003A0D000000000000510D000000000000680D0000000000007F0D000000000000960D000000000000AD0D000000000000C40D000000000000DB0D000000000000F20D000000000000090E000000000000200E000000000000370E0000000000004E0E000000000000650E0000000000007C0E000000000000930E000000000000AA0E000000000000C10E000000000000D80E000000000000EF0E000000000000060F0000000000001D0F000000000000340F0000000000004B0F000000000000620F000000000000790F000000000000900F000000000000A70F000000000000BE0F000000000000D50F000000000000EC0F00000000000003100000000000001A10000000000000311000000000000048100000000000005F1000000000000076100000000000008D10000000000000A410000000000000BB10000000000000D210000000000000E910000000000000001100000000000017110000000000002E1100000000000045110000000000005C1100000000000073110000000000008A11000000000000A111000000000000B811000000000000CF11000000000000E611000000000000FD1100000000000014120000000000002B1200000000000042120000000000005912000000000000701200000000000087120000000000009E12000000000000B512000000000000CC12000000000000E312000000000000FA12000000000000111300000000000028130000000000003F1300000000000056130000000000006D1300000000000084130000000000009B13000000000000B213000000000000C913000000000000E013000000000000F7130000000000000E1400000000000025140000000000003C1400000000000053140000000000006A1400000000000081140000000000009814000000000000AF14000000000000C614000000000000DD14000000000000F4140000000000000B1500000000000022150000000000003915000000000000501500000000000067150000000000007E150000000000009515000000000000AC15000000000000C315000000000000DA15000000000000F11500000000000008160000000000001F1600000000000036160000000000004D1600000000000064160000000000007B160000000000009216000000000000A916000000000000C016000000000000D716000000000000EE1600000000000005170000000000001C1700000000000033170000000000004A17000000000000611700000000000078170000000000008F17000000000000A617000000000000BD17000000000000D417000000000000EB1700000000000002180000000000001000140000006042000000000000803F640000000400001000140000006C4200002B43000064426800000004000010001400000070420000B042000030426B000000040000100014000000804200002043555555426F000000040000100014000000704200009843ABAA4A4276000000040000100014000000604200004843000048427B00000004000010001400000088420080BD43499258428300000004000010001400000024420000C04200004042860000000400001000140000001C4200006643000066428B00000004000010001400000088420000E442000064428E00000004000010001400000060420000C84200004842910000000400001000140000004C42000064430000644296000000040000100014000000744200001B43ABAA4E429A00000004000010001400000080420000C842000048429D000000040000100014000000844200006B4300006B42A20000000400001000140000006C420000594300005942A700000004000010001400000084420080A34300005A42AE00000004000010001400000084420080A64325493E42B60000000400001000140000002C4200002A43ABAA6242BA00000004000010001400000084420000294355556142BE000000040000100014000000744200001B43ABAA4E42C200000004000010001400000034420000D84200005842C5000000040000100014000000884200005F4300005F42CA00000004000010001400000028420000CE4200004E42CD0000000400001000140000002C420000E64200006642D000000004000010001400000054420000344300007042D400000004000010001400000050420000E84200006842D700000004000010001400000030420000FA4200007A42DA0000000400001000140000008E4200000E4355553D42DE000000040000100014000000604200008B4366665E42E400000004000010001400000048420000794300007942E90000000400001000140000008E420000E24200006242EC000000040000100014000000284200004D4300004D42F100000004000010001400000044420000F44200007442F4000000040000100014000000884200808F439A996542FA00000004000010001400000082420000BC4200003C42FD00000004000010001400000086420000784366664642030100000400001000140000008C42000068430000684208010000040000100014000000744200005E4300005E420D01000004000010001400000070420080984355554B4214010000040000100014000000784200001A4355554D4218010000040000100014000000284200001C43000050421C010000040000100014000000344200007C439A9949422201000004000010001400000034420000E242000062422501000004000010001400000064420000CE4200004E42280100000400001000140000008E4200001243ABAA42422C01000004000010001400000070420080814333334F4232010000040000100014000000744200001843ABAA4A4236010000040000100014000000204200002C43555565423A01000004000010001400000030420000CC4200004C423D010000040000100014000000144200003643ABAA72424101000004000010001400000010420000534300005342460100000400001000140000007C4200001C43000050424A01000004000010001400000048420080B143ABAA6C4251010000040000100014000000384200004A4300004A4256010000040000100014000000204200002F43555569425A01000004000010001400000038420000F042000070425D01000004000010001400000080420000CE4200004E426001000004000010001400000078420080A243ABAA58426701000004000010001400000092420000EC4200006C426A01000004000010001400000090420000D642000056426D0100000400001000140000006C4200007F4300004C42730100000400001000140000002C4200004D4300004D42780100000400001000140000002C4200006243000062427D01000004000010001400000020420000D8420000584280010000040000100014000000304200002B4300006442840100000400001000140000002C4200002D43ABAA66428801000004000010001400000038420000A343555559428F010000040000100014000000404200002743ABAA5E42930100000400001000140000004042008097436666724299010000040000100014000000144200007943000079429E01000004000010001400000024420000D24200005242A10100000400001000140000003C4200002B4300006442A50100000400001000140000003C420000D84200005842A80100000400001000140000007C420000DE4200005E42AB01000004000010001400000090420000E44200006442AE01000004000010001400000048420000574300005742B3010000040000100014000000644200005E4300005E42B8010000040000100014000000384200003043ABAA6A42BC0100000400001000140000006C420080B04355556B42C301000004000010001400000082420000674300006742C801000004000010001400000058420000704300004042CE010000040000100014000000504200001F4300005442D20100000400001000140000003C420000324355556D42D60100000400001000140000008C420000E84200006842D90100000400001000140000008A4200003B4355557942DD01000004000010001400000034420000624300006242E2010000040000100014000000144200008C4300006042E80100000400001000140000004C420000104300009042EB01000004000010001400000084420000974355554942F201000004000010001400000078420000E64200006642F501000004000010001400000086420000584300005842FA01000004000010001400000034420000734300007342FF010000040000100014000000444200808A439A995D420502000004000010001400000078420000D04200005042080200000400001000140000008C420000194300004C420C020000040000100014000000304200808C43CDCC6042120200000400001000140000006C420000DC4200005C421502000004000010001400000070420000C042000040421802000004000010001400000040420000814366664E421E02000004000010001400000096420000264355555D42220200000400001000140000008242000011435555414226020000040000100014000000144200005543000055422B020000040000100014000000964200004F4300004F42300200000400001000140000007042000078436666464236020000040000100014000000704200007843000078423B02000004000010001400000034420000D442000054423E0200000400001000140000008C420000E242000062424102000004000010001400000086420000C842000048424402000004000010001400000028420000EE4200006E424702000004000010001400000030420000EE4200006E424A02000004000010001400000034420000E442000064424D0200000400001000140000003C420000E2420000624250020000040000100014000000484200808F439A9965425602000004000010001400000088420000E242000062425902000004000010001400000080420000BC4200003C425C02000004000010001400000040420000FE4200007E425F02000004000010001400000080420000E242000062426202000004000010001400000082420000DA4200005A4265020000040000100014000000444200008B4366665E426B02000004000010001400000044420000DE4200005E426E020000040000100014000000504200005B4300005B427302000004000010001400000030420000E6420000664276020000040000100014000000584200006043000060427B0200000400001000140000003C420000E642000066427E0200000400001000140000006C420000D04200005042810200000400001000140000004C420000A0435555554288020000040000100014000000344200002143ABAA56428C02000004000010001400000080420000DE4200005E428F02000004000010001400000084420000DC4200005C42920200000400001000140000007C4200003343ABAA6E429602000004000010001400000074420000CC4200004C4299020000040000100014000000504200006E4300006E429E02000004000010001400000078420000DE4200005E42A102000004000010001400000082420000874300005842A70200000400001000140000003C420000E24200006242AA02000004000010001400000038420000DC4200005C42AD020000040000100014000000504200006E4300006E42B2020000040000100014000000864200002F4355556942B6020000040000100014000000744200004F4300004F42BB02000004000010001400000048420000E84200006842BE0200000400001000140000005C420000FC4200007C42C102000004000010001400000030420000564300005642C6020000040000100014000000744200001F4300005442CA02000004000010001400000050420080BF436EDB5A42D2020000040000100014000000684200001843ABAA4A42D60200000400001000140000004C420000534300005342DB02000004000010001400000086420000974355554942E202000004000010001400000050420000644300006442E702000004000010001400000054420000514300005142EC02000004000010001400000038420000224300005842F0020000040000100014000000704200005D4300005D42F502000004000010001400000064420000614300006142FA02000004000010001400000070420000704300007042FF0200000400001000140000006442000077430000774204030000040000100014000000284200002D43ABAA66420803000004000010001400000088420000E042000060420B0300000400001000140000004442000078436666464211030000040000100014000000584200006B4300003C42170300000400001000140000004C4200006D4300006D421C030000040000100014000000704200004E4300004E4221030000040000100014000000404200003643ABAA7242250300000400001000140000009E420000F0420000704228030000040000100014000000444200005243000052422D03000004000010001400000038420000554300005542320300000400001000140000001C4200006B4300006B4237030000040000100014000000404200007E4333334B423D0300000400001000140000005C4200005D4300005D42420300000400001000140000005442000061430000614247030000040000100014000000584200006943000069424C0300000400001000140000006442000070430000704251030000040000100014000000604200007E4333334B4257030000040000100014000000804200006043000060425C0300000400001000140000007C4200007A4300007A42610300000400001000140000005C4200005B4300005B4266030000040000100014000000744200007943000079426B03000004000010001400000034420000644300006442700300000400001000140000004842000057430000574275030000040000100014000000244200005B4300005B427A030000040000100014000000504200007643CDCC4442800300000400001000140000007C42000060430000604285030000040000100014000000904200005343000053428A030000040000100014000000444200005A4300005A428F030000040000100014000000384200008443333353429503000004000010001400000058420000BC436EDB56429D03000004000010001400000034420000B24355556D42A40300000400001000140000008C420000794300007942A903000004000010001400000034420000A94355556142B003000004000010001400000028420000604300006042B5030000040000100014000000444200008C4300006042BB030000040000100014000000404200005D4300005D42C0030000040000100014000000284200008543CDCC5442C603000004000010001400000058420000794300007942CB030000040000100014000000824200006D4300006D42D00300000400001000140000002C420000554300005542D50300000400001000140000002C4200001E4474D16542E103000004000010001400000038420000554300005542E60300000400001000140000800D44000000000000803FE70300000400001000140000006442000000000000803FE803000004000050C3000000000000
GO

-- EstimateRows = 1278
SELECT * FROM Order_DetailsBig WHERE Quantity <= 123 OPTION (RECOMPILE)
-- EstimateRows = 1332,143
SELECT * FROM Order_DetailsBig WHERE Quantity <= 124 OPTION (RECOMPILE)
-- EstimateRows = 1372,75
SELECT * FROM Order_DetailsBig WHERE Quantity <= 125 OPTION (RECOMPILE)
-- EstimateRows = 1420,125
SELECT * FROM Order_DetailsBig WHERE Quantity <= 126 OPTION (RECOMPILE)
-- EstimateRows = 1467,5
SELECT * FROM Order_DetailsBig WHERE Quantity <= 127 OPTION (RECOMPILE)
-- EstimateRows = 1514,875
SELECT * FROM Order_DetailsBig WHERE Quantity <= 128 OPTION (RECOMPILE)
-- EstimateRows = 1562,25
SELECT * FROM Order_DetailsBig WHERE Quantity <= 129 OPTION (RECOMPILE)
-- EstimateRows = 1609,625
SELECT * FROM Order_DetailsBig WHERE Quantity <= 130 OPTION (RECOMPILE)
-- EstimateRows = 1725
SELECT * FROM Order_DetailsBig WHERE Quantity <= 131 OPTION (RECOMPILE)