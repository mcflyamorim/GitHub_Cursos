/*
  SQL25 - SQL Server Performance with nowait
  http://www.srnimbus.com.br
*/

-------------------------------------------------
-- Atualizando estatísticas com valores falsos --
-------------------------------------------------
USE Northwind
GO
IF OBJECT_ID('Tab1') IS NOT NULL
  DROP TABLE Tab1
GO
CREATE TABLE Tab1(Col1 Int NOT NULL PRIMARY KEY, Col2 Int)
GO
IF OBJECT_ID('Tab2') IS NOT NULL
  DROP TABLE Tab2
GO
CREATE TABLE Tab2(Col1 Int NOT NULL PRIMARY KEY, Col2 Int)
GO

INSERT INTO Tab1 VALUES(1, 1), (2, 2)
INSERT INTO Tab2 VALUES(1, 1), (2, 2)
GO


-- Plano simples com SORT executando a operação de distinct sort
SELECT DISTINCT(Col2) 
  FROM Tab1
GO

-- Plano com Scan em Tab1 e Seek em Tab2 + Nested Loops e finalmente 
-- um sort por Tab1.Col2 + Tab2.Col2
SELECT * 
  FROM Tab1
 INNER JOIN Tab2 
    ON Tab1.Col1 = Tab2.Col2
 ORDER BY Tab1.Col2 + Tab2.Col2
OPTION (RECOMPILE)
GO
 
-- WITH STATS_STREAM para mostrar os valores de Rows e Data Pages
DBCC SHOW_STATISTICS (Tab1) WITH STATS_STREAM
DBCC SHOW_STATISTICS (Tab2) WITH STATS_STREAM
GO

-- Atualizando para números maiores
UPDATE STATISTICS Tab1 WITH ROWCOUNT = 10000, PAGECOUNT = 10000
UPDATE STATISTICS Tab2 WITH ROWCOUNT = 100000, PAGECOUNT = 100000
GO

-- Plano utilizando Hash Match para processar o distinct das 10 mil linhas
SELECT DISTINCT(Col2)
  FROM Tab1
OPTION (RECOMPILE)
GO

-- Scan em Tab1 e Tab2 + Hash Match para fazer o join e Sort por Tab1.Col2 + Tab2.Col2
SELECT *
  FROM Tab1
 INNER JOIN Tab2 
    ON Tab1.Col1 = Tab2.Col2
 ORDER BY Tab1.Col2 + Tab2.Col2
OPTION (RECOMPILE)
GO

-- Reset ROWCOUNT e PAGECOUNT para números originais...
DBCC UPDATEUSAGE (Northwind,'Tab1') WITH COUNT_ROWS;
GO


-- STATS_STREAM
-- Copiar estatísticas de uma tabela

-- Exemplo 1, analisar generate scritps com Estatísticas

-- Exemplo 2
-- Criar tabela vazia
-- DROP TABLE OrdersBig_Vazia
SELECT * 
  INTO OrdersBig_Vazia
  FROM OrdersBig
 WHERE 1 = 0
GO
ALTER TABLE OrdersBig_Vazia ADD CONSTRAINT xpk_OrdersBig_Vazia PRIMARY KEY(OrderID)
GO

-- Visualizando stats_stream da tabela OrdersBig
DBCC SHOW_STATISTICS (OrdersBig, xpk_OrdersBig) WITH STATS_STREAM
GO
-- Visualizando stats_stream da tabela OrdersBig_Vazia
DBCC SHOW_STATISTICS (OrdersBig_Vazia, xpk_OrdersBig_Vazia) WITH STATS_STREAM
GO

-- Copiando Stats_Stream da OrdersBig para OrdersBig_Vazia
UPDATE STATISTICS OrdersBig_Vazia xpk_OrdersBig_Vazia 
WITH STATS_STREAM = 0x010000000100000000000000000000009DBF638B00000000B3030000000000007303000000000000380376613800000004000A0000000000000000000200000007000000093A6E0035A1000087420F00000000009FB50400000000000000803FF48A8635000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009000000090000000100000014000000000080407028744900000000000080400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000190000000000000000000000000000001701000000000000FF01000000000000070200000000000048000000000000005F0000000000000076000000000000008D00000000000000A400000000000000BB00000000000000D200000000000000E9000000000000000001000000000000100014000000803F000000000000803F03000000040000100014000000803F31D95E47A7FE7F3F75E20000040000100014000000803F16271D4893ED803F8C520300040000100014000000803F7D2AAE482B10803F31C30800040000100014000000803FF1CE91471CCB803F04E50900040000100014000000803F83879B4761FF7F3F5E210B00040000100014000000803FEC6B8248C755803F05320F00040000100014000000803F8B847A459DDC7F3F85420F00040000100014000000803F000000000000803F86420F0004000003000000FC2BF70033A10000000000000C852E4186420F000000000003000000000000A0AAC6B03E00000000000000000000000000000000000000000000F03F0000000000000000E0D65878FDFF0740C543E60033A10000000000000C852E4186420F000000000003000000000000A0AAC6B03E000000000000000000000000000000000000000000000000000000000000000000000000000000007598DD0033A100000000000080842E4140420F000000000002000000000000A0F7C6B03E3ADF9CDEFEBF5140000000000000000000000000008051400000000000000000F647FD14C5C81F3F87420F0000000000,
ROWCOUNT = 1000071, 
PAGECOUNT = 3586
GO

-- Estimativa da OrdersBig
SELECT * 
  FROM OrdersBig
 WHERE OrderID <= 10
OPTION (RECOMPILE)
GO

-- Estimativa da OrdersBig_Vazia
SELECT *
  FROM OrdersBig_Vazia
 WHERE OrderID <= 10
OPTION (RECOMPILE)
GO

-- Joe Chang decodificou parte do stream
-- http://www.qdpma.com/CBO/StatStream.html